<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunch Veto Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; min-height: 100vh; }
        .screen { min-height: 100vh; }
        .hidden { display: none !important; }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-box h1 { text-align: center; margin-bottom: 8px; }
        .login-box p { text-align: center; color: #666; margin-bottom: 24px; }
        .login-box input { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 12px; }
        .login-box button { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }
        .error { color: #e74c3c; text-align: center; margin-top: 12px; }
        header { background: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { font-size: 18px; }
        .user-tag { background: #667eea; color: white; padding: 6px 14px; border-radius: 20px; }
        nav { display: flex; background: white; border-bottom: 1px solid #eee; }
        nav button { flex: 1; padding: 14px; border: none; background: none; font-size: 16px; cursor: pointer; color: #666; }
        nav button.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .content { padding: 20px; max-width: 600px; margin: 0 auto; }
        .round-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        .round-card h2 { color: #666; font-size: 14px; text-transform: uppercase; }
        .picker-name { font-size: 28px; font-weight: bold; color: #667eea; margin: 16px 0; }
        .instruction { color: #888; margin-bottom: 20px; }
        .phase-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .phase-card h3 { margin-bottom: 16px; }
        .restaurant-row { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; }
        .phase-card button { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 16px; }
        .phase-card button:disabled { background: #ccc; cursor: not-allowed; }
        .add-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-row input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; }
        .add-row button { padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .restaurant-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .delete-btn { color: #e74c3c; cursor: pointer; padding: 5px 10px; }
        .winner-banner { background: linear-gradient(135deg, #f093fb, #f5576c); padding: 40px; border-radius: 12px; text-align: center; color: white; }
        .winner-banner h3 { font-size: 24px; margin-bottom: 16px; }
        .winner-name { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
        .winner-banner button { background: white; color: #f5576c; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .history-item { background: white; padding: 16px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .history-date { color: #888; font-size: 13px; }
        .history-winner { font-size: 20px; font-weight: bold; color: #27ae60; margin: 8px 0; }
        .history-picker { color: #666; }
        .nav-buttons { display: flex; gap: 10px; }
        .logout-btn { background: #f0f0f0; color: #666; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-screen" class="screen login-container">
        <div class="login-box">
            <h1>üçï Lunch Tracker</h1>
            <p>Enter your name and password</p>
            <input type="text" id="username" placeholder="Your name">
            <input type="password" id="password" placeholder="Password">
            <button id="login-btn">Join</button>
            <p id="login-error" class="error"></p>
        </div>
    </div>
    
    <div id="main-screen" class="screen hidden">
        <header>
            <h1>üçï Lunch Tracker</h1>
            <div class="nav-buttons">
                <span id="current-user" class="user-tag"></span>
                <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
        </header>
        
        <nav>
            <button id="nav-dash" class="active">Dashboard</button>
            <button id="nav-rest">Restaurants</button>
            <button id="nav-hist">History</button>
        </nav>
        
        <div id="tab-dashboard" class="content">
            <div class="round-card">
                <h2>Current Round</h2>
                <div id="picker-display" class="picker-name">Loading...</div>
                <p id="round-instruction" class="instruction"></p>
            </div>
            
            <div id="phase-suggestion" class="phase-card hidden">
                <h3>Pick 3 Restaurants</h3>
                <div id="suggestions-list"></div>
                <button id="start-veto-btn">Start Veto Phase</button>
            </div>
            
            <div id="phase-veto" class="phase-card hidden">
                <h3>Tap to Veto</h3>
                <div id="veto-list"></div>
                <button id="complete-veto-btn" class="hidden">Pick Winner</button>
            </div>
            
            <div id="phase-winner" class="winner-banner hidden">
                <h3>üéâ Winner!</h3>
                <div id="winner-display" class="winner-name"></div>
                <button id="new-round-btn">Start New Round</button>
            </div>
        </div>
        
        <div id="tab-restaurants" class="content hidden">
            <div class="add-row">
                <input type="text" id="new-restaurant" placeholder="Add new restaurant">
                <button id="add-restaurant-btn">Add</button>
            </div>
            <div id="restaurant-list"></div>
        </div>
        
        <div id="tab-history" class="content hidden">
            <div id="history-list"></div>
        </div>
    </div>

    <script>
    // Global variables
    var supabase;
    var currentUser = null;
    var currentRound = null;
    var USERS = ['craig', 'seth', 'chris'];
    var USERNAMES = ['Craig', 'Seth', 'Chris'];
    var PASSWORD = 'doug_rocks';
    var SUPABASE_URL = 'https://ypvgfmxnjjlymxifpuyc.supabase.co';
    var SUPABASE_KEY = 'sbp_32bc8f2c98f8555da933144021b9d73658b5cd12';

    // Initialize on load
    window.onload = function() {
        console.log('Window loaded');
        
        var saved = localStorage.getItem('lunchUser');
        if (saved) {
            currentUser = saved;
            showMain();
            connectSupabase();
            loadAll();
        }
    };

    // Connect to Supabase
    function connectSupabase() {
        console.log('Connecting to Supabase...');
        supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('Supabase connected');
        
        supabase.channel('lunch-tracker')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'rounds' }, function() {
                console.log('Round changed, reloading');
                loadRound();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'restaurants' }, function() {
                console.log('Restaurants changed, reloading');
                loadRestaurants();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'history' }, function() {
                console.log('History changed, reloading');
                loadHistory();
            })
            .subscribe(function(status) {
                console.log('Subscription status:', status);
            });
    }

    // Login
    document.getElementById('login-btn').onclick = function() {
        console.log('Login clicked');
        var name = document.getElementById('username').value.trim().toLowerCase();
        var password = document.getElementById('password').value;
        
        if (!name || !password) {
            document.getElementById('login-error').textContent = 'Fill in both fields';
            return;
        }
        
        if (password !== PASSWORD) {
            document.getElementById('login-error').textContent = 'Wrong password';
            return;
        }
        
        if (USERS.indexOf(name) === -1) {
            document.getElementById('login-error').textContent = 'Use Craig, Seth, or Chris';
            return;
        }
        
        currentUser = name;
        localStorage.setItem('lunchUser', name);
        showMain();
        connectSupabase();
        loadAll();
    };

    // Logout
    document.getElementById('logout-btn').onclick = function() {
        currentUser = null;
        localStorage.removeItem('lunchUser');
        document.getElementById('main-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    };

    // Show main screen
    function showMain() {
        var displayName = USERNAMES[USERS.indexOf(currentUser)];
        document.getElementById('current-user').textContent = displayName;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
    }

    // Tab navigation
    document.getElementById('nav-dash').onclick = function() {
        showTab('dashboard');
    };
    
    document.getElementById('nav-rest').onclick = function() {
        showTab('restaurants');
    };
    
    document.getElementById('nav-hist').onclick = function() {
        showTab('history');
    };

    function showTab(tab) {
        console.log('Showing tab:', tab);
        
        // Hide all tabs
        document.getElementById('tab-dashboard').classList.add('hidden');
        document.getElementById('tab-restaurants').classList.add('hidden');
        document.getElementById('tab-history').classList.add('hidden');
        
        // Show selected tab
        document.getElementById('tab-' + tab).classList.remove('hidden');
        
        // Update nav buttons
        document.getElementById('nav-dash').classList.remove('active');
        document.getElementById('nav-rest').classList.remove('active');
        document.getElementById('nav-hist').classList.remove('active');
        
        document.getElementById('nav-' + tab.substring(0,4)).classList.add('active');
        
        // Load data
        if (tab === 'restaurants') {
            loadRestaurants();
        } else if (tab === 'history') {
            loadHistory();
        }
    }

    // Load all data
    function loadAll() {
        loadRound();
        loadRestaurants();
        loadHistory();
    }

    // Load round
    function loadRound() {
        console.log('Loading round...');
        supabase.from('rounds')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(1)
            .single()
            .then(function(result) {
                console.log('Round result:', result);
                if (result.error) {
                    console.log('No round found');
                    currentRound = null;
                } else {
                    currentRound = result.data;
                }
                updateRoundDisplay();
            });
    }

    // Start new round
    document.getElementById('new-round-btn').onclick = function() {
        startNewRound();
    };

    function startNewRound() {
        console.log('Starting new round...');
        
        // Get last picker
        supabase.from('rounds')
            .select('picker')
            .order('created_at', { ascending: false })
            .limit(1)
            .then(function(result) {
                var lastPicker = 'chris';
                if (result.data && result.data.length > 0) {
                    lastPicker = result.data[0].picker.toLowerCase();
                }
                
                var idx = USERS.indexOf(lastPicker);
                var nextIdx = (idx + 1) % USERS.length;
                var nextPicker = USERNAMES[nextIdx];
                
                supabase.from('rounds')
                    .insert({
                        picker: nextPicker,
                        phase: 'suggestion',
                        suggestions: [],
                        vetos: {},
                        winner: null
                    })
                    .select()
                    .then(function(insertResult) {
                        if (!insertResult.error) {
                            currentRound = insertResult.data;
                            updateRoundDisplay();
                        }
                    });
            });
    }

    // Update round display
    function updateRoundDisplay() {
        var pickerName = currentRound ? currentRound.picker : 'Nobody';
        var isMyTurn = currentRound && currentUser === currentRound.picker.toLowerCase();
        
        document.getElementById('picker-display').textContent = pickerName + (isMyTurn ? ' (You!)' : '');
        
        if (currentRound) {
            document.getElementById('round-instruction').textContent = isMyTurn
                ? "It's your turn to pick 3 places!"
                : 'Waiting for ' + pickerName + ' to pick...';
        } else {
            document.getElementById('round-instruction').textContent = 'Start a new round below';
        }
        
        // Hide all phases
        document.getElementById('phase-suggestion').classList.add('hidden');
        document.getElementById('phase-veto').classList.add('hidden');
        document.getElementById('phase-winner').classList.add('hidden');
        
        if (!currentRound) {
            document.getElementById('start-veto-btn').onclick = startNewRound;
            document.getElementById('phase-suggestion').classList.remove('hidden');
            document.getElementById('suggestions-list').innerHTML = '<p style="text-align:center;color:#888;padding:20px;">No active round</p>';
            document.getElementById('start-veto-btn').textContent = 'Start New Round';
            document.getElementById('start-veto-btn').disabled = false;
            return;
        }
        
        if (currentRound.phase === 'suggestion') {
            renderSuggestions();
        } else if (currentRound.phase === 'veto') {
            renderVetoList();
        } else if (currentRound.phase === 'winner') {
            document.getElementById('winner-display').textContent = currentRound.winner;
            document.getElementById('phase-winner').classList.remove('hidden');
        }
    }

    // Render suggestions
    function renderSuggestions() {
        document.getElementById('phase-suggestion').classList.remove('hidden');
        var list = document.getElementById('suggestions-list');
        var btn = document.getElementById('start-veto-btn');
        
        var suggestions = currentRound.suggestions || [];
        var isPicker = currentUser === currentRound.picker.toLowerCase();
        
        if (suggestions.length === 0) {
            list.innerHTML = isPicker 
                ? '<p style="text-align:center;color:#888;">Add restaurants from the library below, or type new ones:</p>'
                : '<p style="text-align:center;color:#888;">Waiting for picker...</p>';
        } else {
            var html = '';
            for (var i = 0; i < suggestions.length; i++) {
                html += '<div class="restaurant-row"><span>' + (i+1) + '. ' + suggestions[i] + '</span>';
                if (isPicker) {
                    html += '<span class="delete-btn" onclick="removeSuggestion(' + i + ')">‚úï</span>';
                }
                html += '</div>';
            }
            list.innerHTML = html;
        }
        
        btn.textContent = suggestions.length === 3 
            ? (isPicker ? 'Start Veto Phase' : 'Waiting...')
            : 'Add more places (' + suggestions.length + '/3)';
        btn.disabled = suggestions.length !== 3;
        if (isPicker) btn.onclick = startVeto;
    }

    // Add suggestion
    function addSuggestion(name) {
        var suggestions = currentRound.suggestions ? currentRound.suggestions.slice() : [];
        if (suggestions.length >= 3) return;
        suggestions.push(name);
        
        supabase.from('rounds')
            .update({ suggestions: suggestions })
            .eq('id', currentRound.id)
            .then(function(result) {
                if (!result.error) {
                    currentRound.suggestions = suggestions;
                    renderSuggestions();
                }
            });
    }

    // Remove suggestion
    window.removeSuggestion = function(idx) {
        var suggestions = currentRound.suggestions.filter(function(_, i) { return i !== idx; });
        supabase.from('rounds')
            .update({ suggestions: suggestions })
            .eq('id', currentRound.id)
            .then(function(result) {
                if (!result.error) {
                    currentRound.suggestions = suggestions;
                    renderSuggestions();
                }
            });
    };

    // Start veto phase
    document.getElementById('start-veto-btn').onclick = function() {
        if (document.getElementById('start-veto-btn').textContent === 'Start Veto Phase') {
            supabase.from('rounds')
                .update({ phase: 'veto', vetos: {} })
                .eq('id', currentRound.id)
                .then(function(result) {
                    if (!result.error) {
                        currentRound.phase = 'veto';
                        currentRound.vetos = {};
                        renderVetoList();
                    }
                });
        } else {
            startNewRound();
        }
    };

    // Render veto list
    function renderVetoList() {
        document.getElementById('phase-veto').classList.remove('hidden');
        var list = document.getElementById('veto-list');
        var btn = document.getElementById('complete-veto-btn');
        
        var suggestions = currentRound.suggestions || [];
        var vetos = currentRound.vetos || {};
        var vetoed = Object.values(vetos);
        var isPicker = currentUser === currentRound.picker.toLowerCase();
        var hasVetoed = Object.keys(vetos).map(function(k) { return k.toLowerCase(); }).indexOf(currentUser) !== -1;
        
        // Count vetos per restaurant
        var vetoCounts = {};
        for (var i = 0; i < suggestions.length; i++) {
            vetoCounts[suggestions[i]] = 0;
        }
        for (var i = 0; i < vetoed.length; i++) {
            if (vetoCounts[vetoed[i]] !== undefined) {
                vetoCounts[vetoed[i]]++;
            }
        }
        
        var html = '';
        for (var i = 0; i < suggestions.length; i++) {
            var s = suggestions[i];
            var count = vetoCounts[s];
            var isVetoed = count >= 2;
            var canClick = !isPicker && !isVetoed && !hasVetoed;
            var sEscaped = s.replace(/'/g, "\\'");
            
            html += '<div class="restaurant-row"';
            if (canClick) {
                html += ' onclick="doVeto(\'' + sEscaped + '\')" style="cursor:pointer"';
            }
            html += '>';
            if (isVetoed) {
                html += '<span style="text-decoration:line-through;color:#e74c3c">' + s + '</span>';
            } else {
                html += '<span>' + s + '</span>';
            }
            html += '<span style="background:' + (isVetoed ? '#e74c3c' : '#667eea') + ';color:white;padding:4px 12px;border-radius:20px;font-size:13px">';
            if (isVetoed) {
                html += '‚ùå Vetoed';
            } else {
                html += count + '/2 vetos';
            }
            html += '</span></div>';
        }
        list.innerHTML = html;
        
        // Check if all non-pickers have vetoed
        var nonPickers = USERS.filter(function(u) { return u !== currentRound.picker.toLowerCase(); });
        var allVetoed = true;
        for (var i = 0; i < nonPickers.length; i++) {
            if (Object.keys(vetos).map(function(k) { return k.toLowerCase(); }).indexOf(nonPickers[i]) === -1) {
                allVetoed = false;
                break;
            }
        }
        
        if (allVetoed || isPicker) {
            btn.classList.remove('hidden');
            btn.disabled = !allVetoed;
            btn.textContent = isPicker ? 'Pick Winner' : 'Waiting...';
            if (isPicker) {
                btn.onclick = completeVeto;
            }
        } else {
            btn.classList.add('hidden');
        }
    }

    // Do veto
    window.doVeto = function(restaurant) {
        var vetos = {};
        for (var key in currentRound.vetos) {
            vetos[key] = currentRound.vetos[key];
        }
        vetos[currentUser] = restaurant;
        
        supabase.from('rounds')
            .update({ vetos: vetos })
            .eq('id', currentRound.id)
            .then(function(result) {
                if (!result.error) {
                    currentRound.vetos = vetos;
                    renderVetoList();
                }
            });
    };

    // Complete veto
    function completeVeto() {
        var suggestions = currentRound.suggestions || [];
        var vetos = Object.values(currentRound.vetos || {});
        var vetoed = vetos.filter(function(v, i, self) { return self.indexOf(v) === i; });
        
        var winner = null;
        for (var i = 0; i < suggestions.length; i++) {
            if (vetoed.indexOf(suggestions[i]) === -1) {
                winner = suggestions[i];
                break;
            }
        }
        if (!winner) winner = currentRound.picker;
        
        // Save to history
        supabase.from('history')
            .insert({
                round_id: currentRound.id,
                date: new Date().toISOString().split('T')[0],
                picker: currentRound.picker,
                winner: winner,
                suggestions: JSON.stringify(suggestions),
                vetos: JSON.stringify(vetos)
            })
            .then(function() {
                // Update round
                supabase.from('rounds')
                    .update({ phase: 'winner', winner: winner })
                    .eq('id', currentRound.id)
                    .then(function(result) {
                        if (!result.error) {
                            currentRound.phase = 'winner';
                            currentRound.winner = winner;
                            updateRoundDisplay();
                            loadHistory();
                        }
                    });
            });
    }

    // Complete veto button
    document.getElementById('complete-veto-btn').onclick = function() {
        completeVeto();
    };

    // Load restaurants
    function loadRestaurants() {
        console.log('Loading restaurants...');
        supabase.from('restaurants')
            .select('*')
            .order('name')
            .then(function(result) {
                console.log('Restaurants result:', result);
                var list = document.getElementById('restaurant-list');
                var restaurants = result.data || [];
                
                if (restaurants.length === 0) {
                    // Insert defaults
                    var defaults = ['El Toro', 'Chick-fil-A', 'Panera Bread', 'Texas Roadhouse', 
                                   'Olive Garden', 'Outback', "Applebee's", 'Buffalo Wild Wings'];
                    var promises = [];
                    for (var i = 0; i < defaults.length; i++) {
                        promises.push(supabase.from('restaurants').insert({ name: defaults[i] }));
                    }
                    Promise.all(promises).then(function() {
                        loadRestaurants();
                    });
                    return;
                }
                
                var html = '';
                for (var i = 0; i < restaurants.length; i++) {
                    var r = restaurants[i];
                    html += '<div class="restaurant-item"><span>' + r.name + '</span>';
                    html += '<span class="delete-btn" onclick="deleteRestaurant(\'' + r.id + '\')">‚úï</span></div>';
                }
                list.innerHTML = html;
            });
    }

    // Add restaurant
    document.getElementById('add-restaurant-btn').onclick = function() {
        var input = document.getElementById('new-restaurant');
        var name = input.value.trim();
        if (!name) return;
        
        console.log('Adding restaurant:', name);
        supabase.from('restaurants')
            .insert({ name: name })
            .then(function(result) {
                console.log('Add result:', result);
                input.value = '';
                loadRestaurants();
            });
    };

    // Delete restaurant
    window.deleteRestaurant = function(id) {
        console.log('Deleting restaurant:', id);
        supabase.from('restaurants')
            .delete()
            .eq('id', id)
            .then(function(result) {
                console.log('Delete result:', result);
                loadRestaurants();
            });
    };

    // Load history
    function loadHistory() {
        console.log('Loading history...');
        supabase.from('history')
            .select('*')
            .order('date', { ascending: false })
            .then(function(result) {
                console.log('History result:', result);
                var list = document.getElementById('history-list');
                var history = result.data || [];
                
                if (history.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#888;padding:40px;">No history yet!</p>';
                    return;
                }
                
                var html = '';
                for (var i = 0; i < history.length; i++) {
                    var h = history[i];
                    html += '<div class="history-item"><div class="history-date">' + h.date + '</div>';
                    html += '<div class="history-winner">üèÜ ' + h.winner + '</div>';
                    html += '<div class="history-picker">Picker: ' + h.picker + '</div></div>';
                }
                list.innerHTML = html;
            });
    }

    console.log('Script loaded');
    </script>
</body>
</html>
