<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Lunch Veto Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; min-height: 100vh; }
        .screen { min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* Login */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-box h1 { text-align: center; margin-bottom: 8px; }
        .login-box p { text-align: center; color: #666; margin-bottom: 24px; }
        .login-box input { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 12px; }
        .login-box button { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; }
        .login-box button:hover { background: #5a6fd6; }
        .error { color: #e74c3c; text-align: center; margin-top: 12px; }
        
        /* Main App */
        header { background: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header h1 { font-size: 18px; }
        .user-tag { background: #667eea; color: white; padding: 6px 14px; border-radius: 20px; }
        nav { display: flex; background: white; border-bottom: 1px solid #eee; }
        nav button { flex: 1; padding: 14px; border: none; background: none; font-size: 16px; cursor: pointer; color: #666; }
        nav button.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .content { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        /* Dashboard */
        .round-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        .round-card h2 { color: #666; font-size: 14px; text-transform: uppercase; }
        .picker-name { font-size: 28px; font-weight: bold; color: #667eea; margin: 16px 0; }
        .instruction { color: #888; margin-bottom: 20px; }
        
        .phase-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .phase-card h3 { margin-bottom: 16px; }
        .restaurant-row { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; }
        .phase-card button { width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 16px; }
        .phase-card button:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Restaurants Tab */
        .add-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .add-row input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; }
        .add-row button { padding: 12px 24px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .restaurant-item { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .delete-btn { color: #e74c3c; cursor: pointer; padding: 5px 10px; }
        
        /* Winner */
        .winner-banner { background: linear-gradient(135deg, #f093fb, #f5576c); padding: 40px; border-radius: 12px; text-align: center; color: white; }
        .winner-banner h3 { font-size: 24px; margin-bottom: 16px; }
        .winner-name { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
        .winner-banner button { background: white; color: #f5576c; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; cursor: pointer; }
        
        /* History */
        .history-item { background: white; padding: 16px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .history-date { color: #888; font-size: 13px; }
        .history-winner { font-size: 20px; font-weight: bold; color: #27ae60; margin: 8px 0; }
        .history-picker { color: #666; }
        
        /* Utility */
        .nav-buttons { display: flex; gap: 10px; }
        .logout-btn { background: #f0f0f0; color: #666; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .delete-btn-small { color: #e74c3c; cursor: pointer; padding: 5px 10px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen login-container">
        <div class="login-box">
            <h1>üçï Lunch Tracker</h1>
            <p>Enter your name and password</p>
            <input type="text" id="username" placeholder="Your name">
            <input type="password" id="password" placeholder="Password">
            <button id="login-btn">Join</button>
            <p id="login-error" class="error"></p>
        </div>
    </div>
    
    <!-- Main Screen -->
    <div id="main-screen" class="screen hidden">
        <header>
            <h1>üçï Lunch Tracker</h1>
            <div class="nav-buttons">
                <span id="current-user" class="user-tag"></span>
                <button class="logout-btn" onclick="doLogout()">Logout</button>
            </div>
        </header>
        
        <nav>
            <button id="nav-dash" class="active" onclick="showTab('dashboard')">Dashboard</button>
            <button id="nav-rest" onclick="showTab('restaurants')">Restaurants</button>
            <button id="nav-hist" onclick="showTab('history')">History</button>
        </nav>
        
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="content">
            <div class="round-card">
                <h2>Current Round</h2>
                <div id="picker-display" class="picker-name">Loading...</div>
                <p id="round-instruction" class="instruction"></p>
            </div>
            
            <div id="phase-suggestion" class="phase-card hidden">
                <h3>Pick 3 Restaurants</h3>
                <div id="suggestions-list"></div>
                <button id="start-veto-btn" onclick="startVeto()" disabled>Start Veto Phase</button>
            </div>
            
            <div id="phase-veto" class="phase-card hidden">
                <h3>Tap to Veto</h3>
                <div id="veto-list"></div>
                <button id="complete-veto-btn" onclick="completeVeto()" class="hidden">Pick Winner</button>
            </div>
            
            <div id="phase-winner" class="winner-banner hidden">
                <h3>üéâ Winner!</h3>
                <div id="winner-display" class="winner-name"></div>
                <button onclick="startNewRound()">Start New Round</button>
            </div>
        </div>
        
        <!-- Restaurants Tab -->
        <div id="tab-restaurants" class="content hidden">
            <div class="add-row">
                <input type="text" id="new-restaurant" placeholder="Add new restaurant">
                <button onclick="addRestaurant()">Add</button>
            </div>
            <div id="restaurant-list"></div>
        </div>
        
        <!-- History Tab -->
        <div id="tab-history" class="content hidden">
            <div id="history-list"></div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://ypvgfmxnjjlymxifpuyc.supabase.co';
        const SUPABASE_KEY = 'sbp_32bc8f2c98f8555da933144021b9d73658b5cd12';
        const PASSWORD = 'doug_rocks';
        const USERS = ['craig', 'seth', 'chris'];
        const USERNAMES = ['Craig', 'Seth', 'Chris'];
        
        let supabase;
        let currentUser = null;
        let currentRound = null;
        
        // Initialize
        async function init() {
            const saved = localStorage.getItem('lunchUser');
            if (saved) {
                currentUser = saved;
                showMain();
                await loadAll();
            }
        }
        
        // Setup Supabase
        async function setupSupabase() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Subscribe to changes
            supabase.channel('lunch-tracker')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'rounds' }, loadRound)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'restaurants' }, loadRestaurants)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'history' }, loadHistory)
                .subscribe();
        }
        
        // Login
        function doLogin() {
            const name = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            
            if (!name || !password) {
                document.getElementById('login-error').textContent = 'Fill in both fields';
                return;
            }
            
            if (password !== PASSWORD) {
                document.getElementById('login-error').textContent = 'Wrong password';
                return;
            }
            
            if (!USERS.includes(name)) {
                document.getElementById('login-error').textContent = 'Use Craig, Seth, or Chris';
                return;
            }
            
            currentUser = name;
            localStorage.setItem('lunchUser', name);
            showMain();
            setupSupabase();
            loadAll();
        }
        
        function doLogout() {
            currentUser = null;
            localStorage.removeItem('lunchUser');
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // Show main screen
        function showMain() {
            const displayName = USERNAMES[USERS.indexOf(currentUser)];
            document.getElementById('current-user').textContent = displayName;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
        }
        
        // Tab navigation
        function showTab(tab) {
            document.querySelectorAll('.content > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-' + tab.substring(0,4)).classList.add('active');
        }
        
        // Load all data
        async function loadAll() {
            await Promise.all([loadRound(), loadRestaurants(), loadHistory()]);
        }
        
        // Round Management
        async function loadRound() {
            const { data, error } = await supabase
                .from('rounds')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
            
            currentRound = data || null;
            updateRoundDisplay();
        }
        
        async function startNewRound() {
            // Get last picker
            const { data: rounds } = await supabase
                .from('rounds')
                .select('picker')
                .order('created_at', { ascending: false })
                .limit(1);
            
            let lastPicker = rounds?.length ? rounds[0].picker : 'chris';
            let idx = USERS.indexOf(lastPicker.toLowerCase());
            let nextPicker = USERS[(idx + 1) % USERS.length];
            
            const { data, error } = await supabase
                .from('rounds')
                .insert({
                    picker: USERNAMES[USERS.indexOf(nextPicker)],
                    phase: 'suggestion',
                    suggestions: [],
                    vetos: {},
                    winner: null
                })
                .select()
                .single();
            
            if (!error) {
                currentRound = data;
                updateRoundDisplay();
            }
        }
        
        function updateRoundDisplay() {
            const pickerName = currentRound?.picker || 'Nobody';
            const isMyTurn = currentRound && currentUser === currentRound.picker.toLowerCase();
            
            document.getElementById('picker-display').textContent = 
                pickerName + (isMyTurn ? ' (You!)' : '');
            
            document.getElementById('round-instruction').textContent = isMyTurn
                ? "It's your turn to pick 3 places!"
                : currentRound ? `Waiting for ${pickerName} to pick...` : 'Start a new round below';
            
            // Hide all phases
            ['suggestion', 'veto', 'winner'].forEach(p => 
                document.getElementById('phase-' + p).classList.add('hidden'));
            
            if (!currentRound) {
                document.getElementById('start-veto-btn').onclick = startNewRound;
                document.getElementById('phase-suggestion').classList.remove('hidden');
                document.getElementById('suggestions-list').innerHTML = 
                    '<p style="text-align:center;color:#888;padding:20px;">No active round</p>';
                document.getElementById('start-veto-btn').textContent = 'Start New Round';
                document.getElementById('start-veto-btn').disabled = false;
                return;
            }
            
            if (currentRound.phase === 'suggestion') {
                renderSuggestions();
            } else if (currentRound.phase === 'veto') {
                renderVetoList();
            } else if (currentRound.phase === 'winner') {
                document.getElementById('winner-display').textContent = currentRound.winner;
                document.getElementById('phase-winner').classList.remove('hidden');
            }
        }
        
        // Suggestion Phase
        function renderSuggestions() {
            const phase = document.getElementById('phase-suggestion');
            phase.classList.remove('hidden');
            const list = document.getElementById('suggestions-list');
            const btn = document.getElementById('start-veto-btn');
            
            const suggestions = currentRound.suggestions || [];
            const isPicker = currentUser === currentRound.picker.toLowerCase();
            
            if (suggestions.length === 0) {
                list.innerHTML = isPicker 
                    ? '<p style="text-align:center;color:#888;">Add restaurants from the library below, or type new ones:</p>'
                    : '<p style="text-align:center;color:#888;">Waiting for picker...</p>';
            } else {
                list.innerHTML = suggestions.map((s, i) => 
                    '<div class="restaurant-row"><span>' + (i+1) + '. ' + s + '</span>' +
                    (isPicker ? '<span class="delete-btn-small" onclick="removeSuggestion(' + i + ')">‚úï</span>' : '') +
                    '</div>'
                ).join('');
            }
            
            btn.textContent = suggestions.length === 3 
                ? (isPicker ? 'Start Veto Phase' : 'Waiting...')
                : 'Add more places (' + suggestions.length + '/3)';
            btn.disabled = suggestions.length !== 3;
            if (isPicker) btn.onclick = startVeto;
        }
        
        async function addSuggestion(name) {
            const suggestions = [...(currentRound.suggestions || [])];
            if (suggestions.length >= 3) return;
            suggestions.push(name);
            
            const { error } = await supabase
                .from('rounds')
                .update({ suggestions })
                .eq('id', currentRound.id);
            
            if (!error) {
                currentRound.suggestions = suggestions;
                renderSuggestions();
            }
        }
        
        async function removeSuggestion(idx) {
            const suggestions = currentRound.suggestions.filter((_, i) => i !== idx);
            
            const { error } = await supabase
                .from('rounds')
                .update({ suggestions })
                .eq('id', currentRound.id);
            
            if (!error) {
                currentRound.suggestions = suggestions;
                renderSuggestions();
            }
        }
        
        async function startVeto() {
            const { error } = await supabase
                .from('rounds')
                .update({ phase: 'veto', vetos: {} })
                .eq('id', currentRound.id);
            
            if (!error) {
                currentRound.phase = 'veto';
                currentRound.vetos = {};
                renderVetoList();
            }
        }
        
        // Veto Phase
        function renderVetoList() {
            const phase = document.getElementById('phase-veto');
            phase.classList.remove('hidden');
            const list = document.getElementById('veto-list');
            const btn = document.getElementById('complete-veto-btn');
            
            const suggestions = currentRound.suggestions || [];
            const vetos = currentRound.vetos || {};
            const vetoed = Object.values(vetos);
            const isPicker = currentUser === currentRound.picker.toLowerCase();
            const hasVetoed = Object.keys(vetos).map(k => k.toLowerCase()).includes(currentUser);
            
            // Count vetos per restaurant
            const vetoCounts = {};
            suggestions.forEach(s => vetoCounts[s] = 0);
            vetoed.forEach(v => { if (vetoCounts[v] !== undefined) vetoCounts[v]++; });
            
            list.innerHTML = suggestions.map(s => {
                const count = vetoCounts[s];
                const isVetoed = count >= 2;
                const canClick = !isPicker && !isVetoed && !hasVetoed;
                return '<div class="restaurant-row" onclick="' + (canClick ? "doVeto('" + s.replace(/'/g, "\\'") + "')" : '') + '" style="' + (canClick ? 'cursor:pointer' : '') + '">' +
                    '<span style="' + (isVetoed ? 'text-decoration:line-through;color:#e74c3c' : '') + '">' + s + '</span>' +
                    '<span style="background:' + (isVetoed ? '#e74c3c' : '#667eea') + ';color:white;padding:4px 12px;border-radius:20px;font-size:13px">' +
                    (isVetoed ? '‚ùå Vetoed' : count + '/2 vetos') + '</span></div>';
            }).join('');
            
            // Check if all non-pickers have vetoed
            const nonPickers = USERS.filter(u => u !== currentRound.picker.toLowerCase());
            const allVetoed = nonPickers.every(u => Object.keys(vetos).map(k => k.toLowerCase()).includes(u));
            
            if (allVetoed || isPicker) {
                btn.classList.remove('hidden');
                btn.disabled = !allVetoed;
                btn.textContent = isPicker ? 'Pick Winner' : 'Waiting...';
            } else {
                btn.classList.add('hidden');
            }
        }
        
        async function doVeto(restaurant) {
            const vetos = { ...currentRound.vetos };
            vetos[currentUser] = restaurant;
            
            const { error } = await supabase
                .from('rounds')
                .update({ vetos })
                .eq('id', currentRound.id);
            
            if (!error) {
                currentRound.vetos = vetos;
                renderVetoList();
            }
        }
        
        async function completeVeto() {
            const suggestions = currentRound.suggestions || [];
            const vetos = Object.values(currentRound.vetos || {});
            const vetoed = [...new Set(vetos)];
            
            let winner = suggestions.find(s => !vetoed.includes(s));
            if (!winner) winner = currentRound.picker; // Picker wins if all vetoed
            
            // Save to history
            await supabase.from('history').insert({
                round_id: currentRound.id,
                date: new Date().toISOString().split('T')[0],
                picker: currentRound.picker,
                winner: winner,
                suggestions: JSON.stringify(suggestions),
                vetos: JSON.stringify(vetos)
            });
            
            // Update round
            const { error } = await supabase
                .from('rounds')
                .update({ phase: 'winner', winner })
                .eq('id', currentRound.id);
            
            if (!error) {
                currentRound.phase = 'winner';
                currentRound.winner = winner;
                updateRoundDisplay();
                loadHistory();
            }
        }
        
        // Restaurants Tab
        async function loadRestaurants() {
            const { data, error } = await supabase
                .from('restaurants')
                .select('*')
                .order('name');
            
            const list = document.getElementById('restaurant-list');
            const restaurants = data || [];
            
            if (restaurants.length === 0) {
                // Insert defaults
                const defaults = ['El Toro', 'Chick-fil-A', 'Panera Bread', 'Texas Roadhouse', 
                                 'Olive Garden', 'Outback', 'Applebee\'s', 'Buffalo Wild Wings'];
                for (const name of defaults) {
                    await supabase.from('restaurants').insert({ name });
                }
                loadRestaurants();
                return;
            }
            
            list.innerHTML = restaurants.map((r, i) => 
                '<div class="restaurant-item"><span>' + r.name + '</span>' +
                '<span class="delete-btn" onclick="deleteRestaurant(\'' + r.id + '\')">‚úï</span></div>'
            ).join('');
        }
        
        async function addRestaurant() {
            const input = document.getElementById('new-restaurant');
            const name = input.value.trim();
            if (!name) return;
            
            await supabase.from('restaurants').insert({ name });
            input.value = '';
            loadRestaurants();
        }
        
        async function deleteRestaurant(id) {
            await supabase.from('restaurants').delete().eq('id', id);
            loadRestaurants();
        }
        
        // History Tab
        async function loadHistory() {
            const { data, error } = await supabase
                .from('history')
                .select('*')
                .order('date', { ascending: false });
            
            const list = document.getElementById('history-list');
            const history = data || [];
            
            if (history.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#888;padding:40px;">No history yet!</p>';
                return;
            }
            
            list.innerHTML = history.map(h => 
                '<div class="history-item"><div class="history-date">' + h.date + '</div>' +
                '<div class="history-winner">üèÜ ' + h.winner + '</div>' +
                '<div class="history-picker">Picker: ' + h.picker + '</div></div>'
            ).join('');
        }
        
        // Start
        document.getElementById('login-btn').addEventListener('click', doLogin);
        init();
    </script>
</body>
</html>
